<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin - Nh·∫≠p ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        body {
            background: #f6f7fb;
        }

        .app-shell {
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #111827;
        }

        .sidebar a {
            color: #e5e7eb;
            text-decoration: none;
        }

        .sidebar a:hover {
            color: #fff;
        }

        .brand {
            color: #fff;
            font-weight: 800;
        }

        .nav-pill {
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background .15s ease;
        }

        .nav-pill.active,
        .nav-pill:hover {
            background: rgba(255, 255, 255, .12);
        }

        .card {
            border: 0;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
        }

        .main-header {
            position: sticky;
            top: 0;
            z-index: 1020;
            background: rgba(255, 255, 255, .9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(15, 23, 42, .08);
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 100%;
            }
        }

        .meter-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .form-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .form-card .form-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .form-card .form-control,
        .form-card .form-select {
            background: rgba(255, 255, 255, 0.95);
            border: none;
        }

        .prev-value {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .usage-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 50px;
        }
    </style>
</head>

<body>
    <!-- TOPBAR -->
    <div class="container-fluid py-3">
        <div th:replace="~{admin/fragments/topbar :: topbar('ƒêi·ªán n∆∞·ªõc')}"></div>
    </div>

    <div class="container-fluid app-shell">
        <div class="row g-0">

            <!-- Sidebar -->
            <aside class="sidebar p-3">
                <div class="mb-4 d-flex align-items-center gap-2">
                    <img th:src="@{/anhdaidien.jpg}" alt="Logo"
                        style="width:44px;height:44px;border-radius:12px;object-fit:cover;">
                    <div class="brand fs-5">ADMIN</div>
                </div>

                <div class="d-grid gap-2" id="adminNav">
                    <a class="nav-pill" href="/admin" data-path="/admin">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                    <a class="nav-pill" href="/admin/rooms" data-prefix="/admin/rooms">
                        <i class="bi bi-house-door me-2"></i> Ph√≤ng
                    </a>
                    <a class="nav-pill" href="/admin/tenants" data-prefix="/admin/tenants">
                        <i class="bi bi-people me-2"></i> Kh√°ch thu√™
                    </a>
                    <a class="nav-pill" href="/admin/booking-requests" data-prefix="/admin/booking-requests">
                        <i class="bi bi-inbox me-2"></i> Y√™u c·∫ßu thu√™
                    </a>
                    <a class="nav-pill" href="/admin/contracts" data-prefix="/admin/contracts">
                        <i class="bi bi-file-earmark-text me-2"></i> H·ª£p ƒë·ªìng
                    </a>
                    <a class="nav-pill active" href="/admin/meters" data-prefix="/admin/meters">
                        <i class="bi bi-lightning-charge me-2"></i> ƒêi·ªán n∆∞·ªõc
                    </a>
                    <a class="nav-pill" href="/admin/bills" data-prefix="/admin/bills">
                        <i class="bi bi-receipt me-2"></i> H√≥a ƒë∆°n
                    </a>
                    <a class="nav-pill" href="/admin/feedbacks" data-prefix="/admin/feedbacks">
                        <i class="bi bi-wrench-adjustable me-2"></i> Ph·∫£n √°nh
                    </a>
                    <a class="nav-pill" href="/admin/hostels" data-prefix="/admin/hostels">
                        <i class="bi bi-building me-2"></i> Nh√† tr·ªç
                    </a>
                    <a class="nav-pill" href="/admin/cash-payments" data-prefix="/admin/cash-payments">
                        <i class="bi bi-cash-coin me-2"></i> Duy·ªát thanh to√°n
                    </a>
                    <a class="nav-pill" href="/admin/users" data-prefix="/admin/users">
                        <i class="bi bi-person-gear me-2"></i> Qu·∫£n l√Ω User
                    </a>
                    <a class="nav-pill" href="/admin/revenue" data-prefix="/admin/revenue">
                        <i class="bi bi-graph-up me-2"></i> Th·ªëng k√™
                    </a>
                </div>
            </aside>

            <!-- Main -->
            <main class="col p-0">
                <header class="main-header px-4 py-3 d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fw-semibold">Nh·∫≠p ch·ªâ s·ªë ƒëi·ªán / n∆∞·ªõc</div>
                        <div class="text-muted small">Ghi ch·ªâ s·ªë h√†ng th√°ng cho t·ª´ng ph√≤ng</div>
                    </div>
                    <a class="btn btn-outline-secondary btn-sm" href="/admin">‚Üê Dashboard</a>
                </header>

                <div class="p-4">
                    <!-- Alert messages -->
                    <div th:if="${msg}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i> <span th:text="${msg}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div th:if="${err}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle me-2"></i> <span th:text="${err}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div class="row g-4">
                        <!-- Form nh·∫≠p ch·ªâ s·ªë -->
                        <div class="col-lg-5">
                            <div class="card form-card p-4">
                                <h5 class="mb-4"><i class="bi bi-plus-circle me-2"></i>Th√™m ch·ªâ s·ªë m·ªõi</h5>

                                <form method="post" action="/admin/meters/create" th:object="${newMeter}"
                                    id="meterForm">
                                    <div class="mb-3">
                                        <label class="form-label">Ph√≤ng *</label>
                                        <select class="form-select" th:field="*{roomId}" required id="roomSelect">
                                            <option value="">-- Ch·ªçn ph√≤ng --</option>
                                            <option th:each="r : ${rooms}" th:value="${r.id}"
                                                th:text="${r.roomCode + ' - ' + r.roomName}"
                                                th:selected="${roomId != null and roomId == r.id}"></option>
                                        </select>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-6">
                                            <label class="form-label">Th√°ng *</label>
                                            <select class="form-select" th:field="*{billMonth}" required
                                                id="monthSelect">
                                                <option value="">-- Th√°ng --</option>
                                                <option th:each="m : ${#numbers.sequence(1, 12)}" th:value="${m}"
                                                    th:text="'Th√°ng ' + ${m}"></option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">NƒÉm *</label>
                                            <input type="number" class="form-control" th:field="*{billYear}" min="2000"
                                                required placeholder="2025" id="yearInput">
                                        </div>
                                    </div>

                                    <!-- Hi·ªÉn th·ªã ch·ªâ s·ªë th√°ng tr∆∞·ªõc -->
                                    <div class="prev-value mt-3" id="prevInfo" style="display: none;">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span id="prevInfoText">Ch·ªâ s·ªë th√°ng tr∆∞·ªõc: ƒêi·ªán = 0, N∆∞·ªõc = 0</span>
                                    </div>

                                    <hr class="my-4" style="border-color: rgba(255,255,255,0.3);">

                                    <div class="row g-3">
                                        <div class="col-6">
                                            <label class="form-label">‚ö° ƒêi·ªán c≈©</label>
                                            <input type="number" class="form-control" th:field="*{electricOld}" min="0"
                                                placeholder="T·ª± l·∫•y" id="electricOld">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">‚ö° ƒêi·ªán m·ªõi *</label>
                                            <input type="number" class="form-control" th:field="*{electricNew}" min="0"
                                                required id="electricNew">
                                        </div>
                                    </div>

                                    <div class="row g-3 mt-1">
                                        <div class="col-6">
                                            <label class="form-label">üíß N∆∞·ªõc c≈©</label>
                                            <input type="number" class="form-control" th:field="*{waterOld}" min="0"
                                                placeholder="T·ª± l·∫•y" id="waterOld">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">üíß N∆∞·ªõc m·ªõi *</label>
                                            <input type="number" class="form-control" th:field="*{waterNew}" min="0"
                                                required id="waterNew">
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-light w-100 mt-4 fw-bold">
                                        <i class="bi bi-save me-2"></i>L∆∞u ch·ªâ s·ªë
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Danh s√°ch ch·ªâ s·ªë -->
                        <div class="col-lg-7">
                            <div class="card p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>L·ªãch s·ª≠ ch·ªâ s·ªë</h5>

                                    <!-- Filter theo ph√≤ng -->
                                    <form class="d-flex gap-2" method="get" action="/admin/meters">
                                        <select class="form-select form-select-sm" name="roomId" style="width: auto;">
                                            <option value="">T·∫•t c·∫£ ph√≤ng</option>
                                            <option th:each="r : ${rooms}" th:value="${r.id}"
                                                th:selected="${roomId != null and roomId == r.id}"
                                                th:text="${r.roomCode}"></option>
                                        </select>
                                        <button class="btn btn-sm btn-primary">L·ªçc</button>
                                    </form>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th>Ph√≤ng</th>
                                                <th class="text-center">K·ª≥</th>
                                                <th class="text-center">‚ö° ƒêi·ªán</th>
                                                <th class="text-center">üíß N∆∞·ªõc</th>
                                                <th class="text-end">Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="m : ${meters}">
                                                <td>
                                                    <span class="fw-semibold" th:text="${roomMap[m.roomId]}">P101</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-secondary"
                                                        th:text="${m.billMonth + '/' + m.billYear}">12/2024</span>
                                                </td>
                                                <td class="text-center">
                                                    <div th:text="${m.electricOld + ' ‚Üí ' + m.electricNew}">100 ‚Üí 150
                                                    </div>
                                                    <span class="usage-badge bg-warning text-dark"
                                                        th:text="${'D√πng: ' + (m.electricNew - m.electricOld) + ' kWh'}">D√πng:
                                                        50 kWh</span>
                                                </td>
                                                <td class="text-center">
                                                    <div th:text="${m.waterOld + ' ‚Üí ' + m.waterNew}">10 ‚Üí 15</div>
                                                    <span class="usage-badge bg-info text-dark"
                                                        th:text="${'D√πng: ' + (m.waterNew - m.waterOld) + ' m¬≥'}">D√πng:
                                                        5 m¬≥</span>
                                                </td>
                                                <td class="text-end">
                                                    <form method="post" th:action="@{'/admin/meters/delete/' + ${m.id}}"
                                                        class="d-inline"
                                                        onsubmit="return confirm('X√≥a b·∫£n ghi ch·ªâ s·ªë n√†y?');">
                                                        <input type="hidden" name="roomId" th:value="${roomId}">
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            <tr th:if="${#lists.isEmpty(meters)}">
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                                    Ch∆∞a c√≥ d·ªØ li·ªáu ch·ªâ s·ªë. H√£y th√™m m·ªõi!
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Auto-fill ch·ªâ s·ªë th√°ng tr∆∞·ªõc khi thay ƒë·ªïi ph√≤ng/th√°ng/nƒÉm
        const roomSelect = document.getElementById('roomSelect');
        const monthSelect = document.getElementById('monthSelect');
        const yearInput = document.getElementById('yearInput');
        const electricOld = document.getElementById('electricOld');
        const waterOld = document.getElementById('waterOld');
        const prevInfo = document.getElementById('prevInfo');
        const prevInfoText = document.getElementById('prevInfoText');

        function fetchPreviousReading() {
            const roomId = roomSelect.value;
            const month = monthSelect.value;
            const year = yearInput.value;

            if (!roomId || !month || !year) {
                prevInfo.style.display = 'none';
                return;
            }

            fetch(`/admin/meters/api/previous?roomId=${roomId}&month=${month}&year=${year}`)
                .then(res => res.json())
                .then(data => {
                    if (data.found) {
                        electricOld.value = data.electricOld;
                        waterOld.value = data.waterOld;
                        prevInfoText.textContent = `Ch·ªâ s·ªë th√°ng ${data.prevMonth}/${data.prevYear}: ƒêi·ªán = ${data.electricOld}, N∆∞·ªõc = ${data.waterOld}`;
                        prevInfo.style.display = 'block';
                    } else {
                        electricOld.value = 0;
                        waterOld.value = 0;
                        prevInfoText.textContent = 'Kh√¥ng t√¨m th·∫•y ch·ªâ s·ªë th√°ng tr∆∞·ªõc. M·∫∑c ƒë·ªãnh = 0';
                        prevInfo.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Error fetching previous reading:', err);
                    prevInfo.style.display = 'none';
                });
        }

        // Attach event listeners
        roomSelect.addEventListener('change', fetchPreviousReading);
        monthSelect.addEventListener('change', fetchPreviousReading);
        yearInput.addEventListener('change', fetchPreviousReading);
        yearInput.addEventListener('blur', fetchPreviousReading);

        // Set default year to current year
        if (!yearInput.value) {
            yearInput.value = new Date().getFullYear();
        }

        // Sidebar active state
        (function () {
            const path = window.location.pathname || '';
            const nav = document.getElementById('adminNav');
            if (!nav) return;

            const links = Array.from(nav.querySelectorAll('a.nav-pill'));
            links.forEach(a => a.classList.remove('active'));

            const pref = links.find(a => a.dataset.prefix && path.startsWith(a.dataset.prefix));
            if (pref) { pref.classList.add('active'); }
        })();
    </script>
</body>

</html>